{"version":3,"sources":["../../src/middlewares/auth.js"],"names":["authUser","req","res","next","locals","currentUser","token","headers","signedCookies","cookieName","decoded","decode","jwtSecret","exp","Date","now","end","user","err","userRequired","Error","status","adminRequired","isAdmin"],"mappings":";;;;;;;AAAA;;;;AACA;;;;AACA;;;;;;AAEO,IAAMA,8BAAW,SAAXA,QAAW,CAACC,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAC1CD,MAAIE,MAAJ,CAAWC,WAAX,GAAyB,IAAzB;;AAEA,MAAMC,QACJL,IAAIM,OAAJ,CAAY,gBAAZ,KAAiCN,IAAIO,aAAJ,CAAkB,iBAAOC,UAAzB,CAAjC,IAAyE,EAD3E;;AAGA,MAAIH,KAAJ,EAAW;AACT,QAAI;AACF,UAAMI,UAAU,oBAAIC,MAAJ,CAAWL,KAAX,EAAkB,iBAAOM,SAAzB,CAAhB;AACA,UAAIF,QAAQG,GAAR,IAAeC,KAAKC,GAAL,EAAnB,EAA+B;AAC7Bb,YAAIc,GAAJ,CAAQ,0BAAR,EAAoC,GAApC;AACA;AACD;;AAEDf,UAAIgB,IAAJ,GAAWf,IAAIE,MAAJ,CAAWC,WAAX,GAAyBK,OAApC;AACA,aAAOP,MAAP;AACD,KATD,CASE,OAAOe,GAAP,EAAY;AACZ,aAAOf,MAAP;AACD;AACF,GAbD,MAaO;AACLA;AACD;AACF,CAtBM;;AAwBA,IAAMgB,sCAAe,SAAfA,YAAe,CAAClB,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAC9C,MAAI,CAACF,IAAIgB,IAAT,EAAe;AACb,QAAIC,MAAM,IAAIE,KAAJ,CAAU,MAAV,CAAV;AACAF,QAAIG,MAAJ,GAAa,GAAb;AACAlB,SAAKe,GAAL;AACA;AACD;;AAEDf;AACD,CATM;;AAWA,IAAMmB,wCAAgB,SAAhBA,aAAgB,CAACrB,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAC/C,MAAI,CAACF,IAAIgB,IAAT,EAAe;AACb,QAAIC,MAAM,IAAIE,KAAJ,CAAU,MAAV,CAAV;AACAF,QAAIG,MAAJ,GAAa,GAAb;AACAlB,SAAKe,GAAL;AACA;AACD;;AAED,MAAI,CAACjB,IAAIgB,IAAJ,CAASM,OAAd,EAAuB;AACrB,QAAIL,OAAM,IAAIE,KAAJ,CAAU,SAAV,CAAV;AACAF,SAAIG,MAAJ,GAAa,GAAb;AACAlB,SAAKe,IAAL;AACA;AACD;;AAEDf;AACD,CAhBM","file":"auth.js","sourcesContent":["import jwt from 'jwt-simple';\r\nimport config from '../config';\r\nimport UserModel from '../models/user';\r\n\r\nexport const authUser = (req, res, next) => {\r\n  res.locals.currentUser = null;\r\n\r\n  const token =\r\n    req.headers['x-access-token'] || req.signedCookies[config.cookieName] || '';\r\n\r\n  if (token) {\r\n    try {\r\n      const decoded = jwt.decode(token, config.jwtSecret);\r\n      if (decoded.exp <= Date.now()) {\r\n        res.end('Access token has expired', 400);\r\n        return;\r\n      }\r\n       \r\n      req.user = res.locals.currentUser = decoded;\r\n      return next();\r\n    } catch (err) {\r\n      return next();\r\n    }\r\n  } else {\r\n    next();\r\n  }\r\n};\r\n\r\nexport const userRequired = (req, res, next) => {\r\n  if (!req.user) {\r\n    let err = new Error('需要登录');\r\n    err.status = 403;\r\n    next(err);\r\n    return;\r\n  }\r\n\r\n  next();\r\n};\r\n\r\nexport const adminRequired = (req, res, next) => {\r\n  if (!req.user) {\r\n    let err = new Error('需要登录');\r\n    err.status = 403;\r\n    next(err);\r\n    return;\r\n  }\r\n\r\n  if (!req.user.isAdmin) {\r\n    let err = new Error('需要管理员权限');\r\n    err.status = 403;\r\n    next(err);\r\n    return;\r\n  }\r\n\r\n  next();\r\n};\r\n"]}